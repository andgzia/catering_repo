/*jshint strict: false, undef: false, trailing: false, curly: false, nomen: false, expr: true, onecase: true, eqeqeq: false, eqnull: true, white: false, array: false, asi: true, plusplus: false, laxcomma: true, laxbreak: true, shadow: true, smarttabs: false, supernew: true, nonew: false, funcscope: true, forin: false */
/** WHEN EDITING FILE REPLACE WITH: /  strict:false */
/*global mns: true, jQuery: true, testMode: true, log: true*/

/*
File: mns.bizSlideContent.js
Functions around the bizSlideContent selector
*/

(function (bizSlideContent, WIN, jQuery, t, undefined){ /* Namespace : mns.bizSlideContent */

    bizSlideContent.object,
    bizSlideContent.visibleWidth,
    bizSlideContent.controls,
    bizSlideContent.selected,

    /*
    Function: mns.bizSlideContent.init
    Run one off d,pendencies (eg: subscriptions) then destroy

    Returns:
    boolean - true if reaches end
    */
    bizSlideContent.init = function (){
        mns.msg.pub('/log','mns.bizSlideContent.init');
        return bizSlideContent.init = function(){
            mns.msg.pub('/log','mns.bizSlideContent.init does not need to run again');
            return true;
        };
    };


    /*
    Function: mns.bizSlideContent.begin
    */
    bizSlideContent.begin = function($el){
        bizSlideContent.animateBy3($el);
        bizSlideContent.object = $el;
        $el.data('notches', $el.find('tr:eq(1)').children('td').length - 0);
        $el.data('active', 1);   
        bizSlideContent.build();
    };
    
    bizSlideContent.build = function($el) {
        
        bizSlideContent.controls = $('<ul class="slideContent-controls"><li class="next"><a href="#" title="Next">Next</a></li><li class="previous"><a href="#" title="Previous">Previous</a></li></ul>');
        bizSlideContent.controls.prependTo(bizSlideContent.object.parents('.slide'));
        bizSlideContent.visibleWidth = bizSlideContent.object.parents('.slide-container').width(),
        controlsPrev = bizSlideContent.controls.find(".previous"),
        controlsNext = bizSlideContent.controls.find(".next");

        var labels = $('<ul class="table-labels" />'),
        height = 0,
        count = 0;
    
        bizSlideContent.object.find('table').find('.label').each(function(){   
            var $this = $(this),
            labelClass="",
            elementHeight = $this.outerHeight();
            
            if ($this.hasClass("full")) {
                labelClass = " full";
                $this.parent('tr').height(elementHeight + 1);
            }                   
            labels.append($('<li class="count_'+count+ labelClass+'"><a href="#" title="'+$this.text()+'">'+$this.text()+'</a></li>'));
            count++;
            $this.remove();
        });

        labels.appendTo(bizSlideContent.object.parents('.slide-container'));
        bizSlideContent.adjustHeight($el);
        bizSlideContent.calculateWidth();
        
        if (bizSlideContent.object.data('notches') > 3) {
        
            controlsPrev.click(function() {
                $controls = $(this).parent('.slideContent-controls');
                $slideContainer = $(this).parents('.slide').find('.slide-container');
                $slide = $slideContainer.find('.slide-content')
                $notches = $slide.data('notches');
                
                if($slide.data('active') > 2){
                    $slide.data('active', $slide.data('active') - 3); 
                    bizSlideContent.slide($slide, $slide.data('active'));
                }
        
                // Disable the back control buttons if it's the first item
                if ($slide.data('active') == 1) {
                    bizSlideContent.disableBackButtons($controls);
                } else {
                    bizSlideContent.enableBackButtons($controls);
                }
        
                if ($slide.data('active') === $notches-2) {
                    controlsNext.removeClass("disabled");
                } else {
                    bizSlideContent.enableForwardButtons($controls);
                }
            });
    
            controlsNext.click(function() {
                $controls = $(this).parent('.slideContent-controls');
                $slideContainer = $(this).parents('.slide').find('.slide-container');
                $slide = $slideContainer.find('.slide-content')
                $notches = $slide.data('notches');
                                
                if($slide.data('active') < $notches-4){
                    $slide.data('active', $slide.data('active') + 3);
                    bizSlideContent.slide($slide, $slide.data('active'));
                    bizSlideContent.enableBackButtons($controls);
                } 
                if ($slide.data('active') == $notches-3) {
                    bizSlideContent.disableForwardButtons($controls);
                } else {
                    bizSlideContent.enableForwardButtons($controls);
                }
            });
                

            // Disable the previous button
            bizSlideContent.disableBackButtons(bizSlideContent.controls );
        } else {
            // Hide all buttons as they cannot be used
            bizSlideContent.hideButtons(bizSlideContent.controls );
        }
    };


    // Enable and disable slide control buttons
    bizSlideContent.hideButtons = function ($slideContent) {
        $slideContent.find('.previous, .next').hide();
    };
    bizSlideContent.disableBackButtons = function($slideContent) {
        $slideContent.find('.previous').addClass("disabled");
    };
    bizSlideContent.disableForwardButtons = function($slideContent) {
        $slideContent.find('.next').addClass("disabled");
    };
    bizSlideContent.enableBackButtons = function($slideContent) {
        $slideContent.find('.previous').removeClass("disabled");
    };
    bizSlideContent.enableForwardButtons = function($slideContent) {
        $slideContent.find('.next').removeClass("disabled");
    };
    
    bizSlideContent.adjustHeight = function($el) {
        $rows = bizSlideContent.object.find('table').find('tr');
        bizSlideContent.object.parent('.slide-container').find('li').each(function(index) {
            // Set the height of both the li and tr
            $max = Math.max($($rows.get(index)).height(), $(this).height());            
            $($rows.get(index)).height($max + 1);
            $(this).height($max);
        });
    };
    
    bizSlideContent.calculateWidth = function(){
        var thisWidth = 0;
        bizSlideContent.object.find('tr:eq(1)').children('td').each(function(){
            var $this = $(this);
            $this.data('current-width', thisWidth);
            $this.attr('title', thisWidth);
            thisWidth += $this.outerWidth();
        });
        bizSlideContent.slide(bizSlideContent.object, bizSlideContent.object.data('active'));
    };
    
    bizSlideContent.animateBy3 = function($el){
         /* Adds extra columns to make size guide multiple of 3 to scroll 3 sizes at once */


        $el.each(function(){
            var remainderCount = 0;
            var tdList = $(this).find("tr:eq(2) td:not(.label)");
            var testRemainder = tdList.length % 3;
            
            while (remainderCount < testRemainder) {
                
                $(this).find("tr td:last-child").after('<td></td>');
                remainderCount++; 
                testRemainder = $(this).find("tr:eq(2) td:not(.label)").length % 3;
             }  
        }) // end each function
    };
    
    bizSlideContent.slide = function($el, $to){
        $el.animateCss({cssX: (242 - $el.find('tr:eq(1)').find('td:eq('+$to+')').data('current-width'))});
    };
    
})(mns.bizSlideContent = mns.bizSlideContent || {}, window, jQuery, testMode.bizSlideContent || {});







